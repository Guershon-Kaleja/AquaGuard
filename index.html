<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaGuard - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* TON DESIGN D'ORIGINE */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .dashboard { max-width: 1000px; margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin-top: 0; color: #555; }
        .value { font-size: 2.5rem; font-weight: bold; color: #007bff; margin: 10px 0; }
        .unit { font-size: 1rem; color: #777; }
        .status-card { grid-column: 1 / -1; }
        #status { font-size: 1.5rem; font-weight: bold; padding: 10px; border-radius: 8px; display: inline-block; margin-top: 10px; }
        .status-normal { background-color: #d4edda; color: #155724; }
        .status-fuite { background-color: #f8d7da; color: #721c24; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
        .chart-container { grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <h1 style="text-align: center; color: #007bff;">ðŸ’§ AquaGuard System</h1>

    <div class="dashboard">
        <div class="card">
            <h3>DÃ©bit Amont</h3>
            <div id="val-up" class="value">--</div>
            <div class="unit">Litre / minute</div>
        </div>

        <div class="card">
            <h3>DÃ©bit Aval</h3>
            <div id="val-down" class="value">--</div>
            <div class="unit">Litre / minute</div>
        </div>

        <div class="card status-card">
            <h3>Ã‰tat du RÃ©seau</h3>
            <div id="status" class="status-normal">Chargement...</div>
        </div>

        <div class="chart-container">
            <canvas id="flowChart"></canvas>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const DB_URL = "https://aquaguard-e5ecf-default-rtdb.firebaseio.com/logs.json";

        // INITIALISATION DU GRAPHIQUE
        const ctx = document.getElementById('flowChart').getContext('2d');
        const flowChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Amont (L/min)',
                    borderColor: '#007bff',
                    data: [],
                    tension: 0.3,
                    fill: false
                }, {
                    label: 'Aval (L/min)',
                    borderColor: '#6c757d',
                    data: [],
                    tension: 0.3,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        async function updateDashboard() {
            try {
                // On rÃ©cupÃ¨re les 10 derniÃ¨res entrÃ©es
                const response = await fetch(`${DB_URL}?orderBy="timestamp"&limitToLast(10)`);
                const data = await response.json();

                if (data && Object.keys(data).length > 0) {
                    // Firebase renvoie un objet, on le convertit en tableau triÃ© par temps
                    const logs = Object.keys(data)
                        .map(key => data[key])
                        .sort((a, b) => a.timestamp - b.timestamp);

                    const latest = logs[logs.length - 1];

                    // Mise Ã  jour des chiffres
                    document.getElementById('val-up').innerText = latest.flow_up.toFixed(2);
                    document.getElementById('val-down').innerText = latest.flow_down.toFixed(2);

                    // Mise Ã  jour de l'Ã©tat
                    const statusEl = document.getElementById('status');
                    statusEl.innerText = latest.status;
                    statusEl.className = latest.status === "FUITE" ? "status-fuite" : "status-normal";

                    // Mise Ã  jour du graphique
                    const labels = logs.map(l => new Date(l.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
                    flowChart.data.labels = labels;
                    flowChart.data.datasets[0].data = logs.map(l => l.flow_up);
                    flowChart.data.datasets[1].data = logs.map(l => l.flow_down);
                    flowChart.update('none');
                }
            } catch (error) {
                console.error("Erreur dashboard:", error);
            }
        }

        // RafraÃ®chissement toutes les 3 secondes
        setInterval(updateDashboard, 3000);
        updateDashboard();
    </script>
</body>
</html>
