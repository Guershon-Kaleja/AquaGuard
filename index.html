<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaGuard - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; text-align: center; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .value { font-size: 2.5em; font-weight: bold; color: #007bff; }
        .status-ok { color: #28a745; font-weight: bold; font-size: 1.5em; }
        .status-leak { color: #dc3545; font-weight: bold; font-size: 1.5em; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        canvas { max-width: 100%; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üíß AquaGuard Monitor</h1>
    
    <div class="grid">
        <div class="card">
            <h3>D√©bit Amont (Up)</h3>
            <div id="val-up" class="value">0.00</div>
            <span>L/min</span>
        </div>
        <div class="card">
            <h3>D√©bit Aval (Down)</h3>
            <div id="val-down" class="value">0.00</div>
            <span>L/min</span>
        </div>
    </div>

    <div class="card">
        <h3>√âtat du Syst√®me</h3>
        <div id="status" class="status-ok">INITIALISATION...</div>
    </div>

    <canvas id="flowChart"></canvas>
</div>

<script>
    // URL de ta Realtime Database (format JSON)
    const DB_URL = "https://aquaguard-e5ecf-default-rtdb.firebaseio.com/logs.json";

    // Configuration initiale du graphique Chart.js
    const ctx = document.getElementById('flowChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'D√©bit Amont (L/min)',
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    data: [],
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'D√©bit Aval (L/min)',
                    borderColor: '#6c757d',
                    borderDash: [5, 5],
                    data: [],
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    async function fetchData() {
        try {
            // R√©cup√®re les 15 derniers enregistrements tri√©s par timestamp
            const response = await fetch(`${DB_URL}?orderBy="timestamp"&limitToLast(15)`);
            const data = await response.json();

            if (data) {
                // Convertir l'objet Firebase en tableau et trier par temps
                const logs = Object.keys(data).map(key => data[key]);
                logs.sort((a, b) => a.timestamp - b.timestamp);

                const latest = logs[logs.length - 1];

                // 1. Mise √† jour de l'affichage textuel
                document.getElementById('val-up').innerText = latest.flow_up.toFixed(2);
                document.getElementById('val-down').innerText = latest.flow_down.toFixed(2);
                
                const statusEl = document.getElementById('status');
                statusEl.innerText = latest.status;
                statusEl.className = latest.status === "FUITE" ? "status-leak" : "status-ok";

                // 2. Mise √† jour du graphique
                const labels = logs.map(l => {
                    const date = new Date(l.timestamp);
                    return date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0') + ":" + String(date.getSeconds()).padStart(2, '0');
                });
                
                myChart.data.labels = labels;
                myChart.data.datasets[0].data = logs.map(l => l.flow_up);
                myChart.data.datasets[1].data = logs.map(l => l.flow_down);
                myChart.update('none'); // Update sans animation pour plus de fluidit√©
            }
        } catch (error) {
            console.error("Erreur de r√©cup√©ration :", error);
        }
    }

    // Rafra√Æchir toutes les 3 secondes
    setInterval(fetchData, 3000);
    fetchData(); // Premier appel imm√©diat
</script>

</body>
</html>
